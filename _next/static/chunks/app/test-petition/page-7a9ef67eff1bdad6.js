(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[532],{7305:function(e,t,s){Promise.resolve().then(s.bind(s,4165))},4165:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return p}});var n=s(7437),r=s(2265),a=s(2141),o=s(9637);let i=new Map,c=new Map;async function l(e,t){try{console.log("Attempting to vote on petition ID:",e);let s=(0,o.Lm)();if(!(0,o.Dn)("vote",s).allowed)return{success:!1,message:"Too many votes. Please wait before voting again."};if(!e||"string"!=typeof e||e.length<10)return{success:!1,message:"Invalid petition ID"};if(!["upvote","downvote"].includes(t))return{success:!1,message:"Invalid vote type"};let{error:n}=await a.O.from("votes").insert({petition_id:e,fingerprint:s,ip_hash:s.slice(0,16),type:t.toUpperCase()});if(n){if("23505"===n.code)return{success:!1,message:"You have already voted on this petition"};return console.error("Error creating vote:",n),{success:!1,message:"Failed to record vote"}}i.delete(e),c.delete("".concat(e,"-").concat(s));let r=await u(e);return console.log("Vote cast successfully, updated counts:",r),{success:!0,message:"Vote recorded successfully",voteCounts:r}}catch(e){return console.error("Vote casting failed:",e),{success:!1,message:"Vote failed. Please try again."}}}async function u(e){try{let t=i.get(e);if(t&&Date.now()-t.timestamp<3e4)return t.data;let{data:s,error:n}=await a.O.from("petitions").select("upvotes, downvotes").eq("id",e).maybeSingle();if(n)return console.error("Error fetching vote counts:",n),{upvotes:0,downvotes:0};let r={upvotes:(null==s?void 0:s.upvotes)||0,downvotes:(null==s?void 0:s.downvotes)||0};return console.log("Vote counts for ".concat(e,":"),r),i.set(e,{data:r,timestamp:Date.now()}),r}catch(e){return console.error("Get vote counts failed:",e),{upvotes:0,downvotes:0}}}async function m(e){try{let t=(0,o.Lm)(),s="".concat(e,"-").concat(t),n=c.get(s);if(n&&Date.now()-n.timestamp<3e4)return n.data;let{data:r,error:i}=await a.O.from("votes").select("type").eq("petition_id",e).eq("fingerprint",t).maybeSingle();if(i)return console.error("Error fetching user vote:",i),null;let l=r?r.type.toLowerCase():null;return c.set(s,{data:l,timestamp:Date.now()}),l}catch(e){return console.error("Get user vote failed:",e),null}}async function d(e,t,s,n,r,i){try{let c=(0,o.Lm)(),l=(0,o.Dn)("comment",c);if(!l.allowed)return{success:!1,message:"Too many comments. Please wait ".concat((0,o.dH)(l.remainingTime||0)," before commenting again.")};if(!e||"string"!=typeof e||e.length<10)return{success:!1,message:"Invalid petition ID"};let u=(0,o.Vl)(t);if(!u.valid)return{success:!1,message:u.message};if(s&&!(0,o.Ol)(s))return{success:!1,message:"Please enter a valid name (2-100 characters, letters only)"};if(n&&!(0,o.oH)(n))return{success:!1,message:"Please enter a valid email address"};if(r&&!/^\d{5}(-\d{4})?$/.test(r.trim()))return{success:!1,message:"Please enter a valid zipcode (e.g., 98125)"};let{data:m,error:d}=await a.O.from("comments").insert({petition_id:e,content:u.sanitized,author_name:(null==s?void 0:s.trim())||"Anonymous",email:(null==n?void 0:n.trim())||null,zipcode:(null==r?void 0:r.trim())||null,fingerprint:c,parent_id:i,is_public:!0,verified:!1}).select().single();if(d)return console.error("Error creating comment:",d),{success:!1,message:"Failed to create comment"};return{success:!0,message:"Comment created successfully",comment:m}}catch(e){return console.error("Create comment failed:",e),{success:!1,message:"Failed to create comment"}}}async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"upvotes";try{if(!e||"string"!=typeof e||e.length<10)return console.error("Invalid petition ID for comments"),[];let{data:s,error:n}=await a.O.from("comments").select("*").eq("petition_id",e).eq("is_public",!0).is("parent_id",null).order("upvotes"===t?"upvotes":"created_at",{ascending:!1});if(n)return console.error("Error fetching comments:",n),[];return await Promise.all((s||[]).map(async e=>{let{data:t}=await a.O.from("comments").select("*").eq("parent_id",e.id).eq("is_public",!0).order("created_at",{ascending:!0});return{...e,replies:t||[]}}))}catch(e){return console.error("Get comments failed:",e),[]}}function p(){let[e]=(0,r.useState)("lake-city-grocery-pharmacy-access"),[t,s]=(0,r.useState)({upvotes:0,downvotes:0}),[a,o]=(0,r.useState)(null),[i,c]=(0,r.useState)([]),[p,h]=(0,r.useState)(!1),[f,v]=(0,r.useState)("");(0,r.useEffect)(()=>{x(),y()},[]);let x=async()=>{try{let t=await u(e);s(t);let n=await m(e);o(n)}catch(e){console.error("Error loading vote counts:",e)}},y=async()=>{try{let t=await g(e);c(t)}catch(e){console.error("Error loading comments:",e)}},w=async t=>{h(!0),v("");try{let n=await l(e,t);n.success?(v("✅ ".concat(n.message)),s(n.voteCounts),o(t)):v("❌ ".concat(n.message))}catch(e){v("❌ Error: ".concat(e))}finally{h(!1)}},b=async()=>{let t=prompt("Enter your comment:");if(t){h(!0),v("");try{let s=await d(e,t,"Test User");s.success?(v("✅ ".concat(s.message)),y()):v("❌ ".concat(s.message))}catch(e){v("❌ Error: ".concat(e))}finally{h(!1)}}};return(0,n.jsxs)("div",{className:"max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-lg",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold mb-6",children:"\uD83E\uDDEA Petition & Voting Test"}),(0,n.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-lg",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-2",children:"Lake City Community Petition"}),(0,n.jsxs)("p",{className:"text-gray-600 mb-2",children:["ID: ",e]}),(0,n.jsx)("p",{className:"text-sm text-gray-500",children:"Join your neighbors in advocating for better grocery and pharmacy access in Lake City. Vote and comment on community proposals."})]}),(0,n.jsxs)("div",{className:"mb-6",children:[(0,n.jsx)("h3",{className:"text-lg font-semibold mb-3",children:"Voting"}),(0,n.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,n.jsxs)("button",{onClick:()=>w("upvote"),disabled:p||"upvote"===a,className:"px-4 py-2 rounded-lg font-medium ".concat("upvote"===a?"bg-green-500 text-white":"bg-green-100 text-green-800 hover:bg-green-200"," ").concat(p?"opacity-50 cursor-not-allowed":""),children:["\uD83D\uDC4D Upvote (",t.upvotes,")"]}),(0,n.jsxs)("button",{onClick:()=>w("downvote"),disabled:p||"downvote"===a,className:"px-4 py-2 rounded-lg font-medium ".concat("downvote"===a?"bg-red-500 text-white":"bg-red-100 text-red-800 hover:bg-red-200"," ").concat(p?"opacity-50 cursor-not-allowed":""),children:["\uD83D\uDC4E Downvote (",t.downvotes,")"]})]}),a&&(0,n.jsxs)("p",{className:"text-sm text-gray-600",children:["You voted: ",(0,n.jsx)("span",{className:"font-medium",children:a})]})]}),(0,n.jsxs)("div",{className:"mb-6",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,n.jsxs)("h3",{className:"text-lg font-semibold",children:["Comments (",i.length,")"]}),(0,n.jsx)("button",{onClick:b,disabled:p,className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50",children:"Add Comment"})]}),(0,n.jsxs)("div",{className:"space-y-3",children:[i.map(e=>(0,n.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,n.jsx)("span",{className:"font-medium text-sm",children:e.author_name||"Anonymous"}),(0,n.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleString()})]}),(0,n.jsx)("p",{className:"text-sm text-gray-700",children:e.content})]},e.id)),0===i.length&&(0,n.jsx)("p",{className:"text-gray-500 text-sm italic",children:"No comments yet. Be the first to comment!"})]})]}),f&&(0,n.jsx)("div",{className:"p-3 rounded-lg text-sm ".concat(f.includes("✅")?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:f}),(0,n.jsxs)("div",{className:"mt-6 p-4 bg-gray-100 rounded-lg",children:[(0,n.jsx)("h4",{className:"font-semibold mb-2",children:"Debug Info"}),(0,n.jsxs)("div",{className:"text-xs space-y-1",children:[(0,n.jsxs)("p",{children:["Vote Counts: ",JSON.stringify(t)]}),(0,n.jsxs)("p",{children:["User Vote: ",a]}),(0,n.jsxs)("p",{children:["Comments Count: ",i.length]}),(0,n.jsxs)("p",{children:["Loading: ",p.toString()]})]})]})]})}},9637:function(e,t,s){"use strict";function n(e){return!!e&&"string"==typeof e&&/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(e.trim())&&e.length<=254}function r(e){return!!e&&"string"==typeof e&&/^[a-zA-Z\s\-']{2,100}$/.test(e.trim())}function a(e){if(!e||"string"!=typeof e)return{valid:!1,message:"Comment cannot be empty"};let t=e.trim();if(t.length<10)return{valid:!1,message:"Comment must be at least 10 characters long"};if(t.length>1e3)return{valid:!1,message:"Comment must be less than 1000 characters"};for(let e of[/(http|https|www\.)/gi,/[A-Z]{10,}/g,/(.)\1{5,}/g,/(.)\1{4,}/g,/\b(buy|sell|free|money|cash|click|here|now)\b/gi])if(e.test(t))return{valid:!1,message:"Comment contains suspicious content"};return{valid:!0,sanitized:function(e){if("string"!=typeof e)return"";let t=e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"");return(t=(t=(t=(t=(t=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"")).replace(/javascript:/gi,"")).replace(/vbscript:/gi,"")).replace(/on\w+\s*=/gi,"")).replace(/('|(\\')|(;)|(\-\-)|(\s+or\s+)|(\s+and\s+))/gi,"")).replace(/\s+/g," ").trim()}(t)}}s.d(t,{Dn:function(){return u},Lm:function(){return d},Ol:function(){return r},Vl:function(){return a},dH:function(){return m},oH:function(){return n}});class o{isAllowed(e){let t=Date.now(),s=(this.attempts.get(e)||[]).filter(e=>t-e<this.windowMs);return!(s.length>=this.maxAttempts)&&(s.push(t),this.attempts.set(e,s),!0)}getRemainingTime(e){let t=this.attempts.get(e)||[];return t.length<this.maxAttempts?0:Math.max(0,this.windowMs-(Date.now()-Math.min(...t)))}constructor(e=5,t=6e4){this.attempts=new Map,this.maxAttempts=e,this.windowMs=t}}let i=new o(3,6e4),c=new o(10,6e4),l=new o(5,3e5);function u(e,t){let s;switch(e){case"comment":s=i;break;case"vote":s=c;break;case"signature":s=l;break;default:return{allowed:!1}}let n=s.isAllowed(t),r=n?0:s.getRemainingTime(t);return{allowed:n,remainingTime:r}}function m(e){let t=Math.ceil(e/1e3);if(t<60)return"".concat(t," seconds");let s=Math.ceil(t/60);return"".concat(s," minute").concat(1!==s?"s":"")}function d(){try{let e=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,new Date().getTimezoneOffset(),navigator.hardwareConcurrency||0,navigator.maxTouchPoints||0,navigator.platform,window.devicePixelRatio||1,navigator.cookieEnabled?"1":"0",navigator.doNotTrack||"0"],t=document.createElement("canvas"),s=t.getContext("2d");s&&(s.textBaseline="top",s.font="14px Arial",s.fillText("Browser fingerprint",2,2),e.push(t.toDataURL()));let n=e.join("|"),r=btoa(n).slice(0,16);return r.length<16&&(r=r.padEnd(16,"0")),r}catch(t){console.error("Secure fingerprint generation failed:",t);let e=btoa([navigator.userAgent,navigator.language,screen.width+"x"+screen.height].join("|")).slice(0,16);return e.length<16&&(e=e.padEnd(16,"0")),e}}},2141:function(e,t,s){"use strict";s.d(t,{O:function(){return o}});var n=s(9683);let r="https://rnnzekyvmaibmewzxypa.supabase.co/",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJubnpla3l2bWFpYm1ld3p4eXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5OTE0NzUsImV4cCI6MjA3NTU2NzQ3NX0.3ZwEnR0up8Ma7KExtXFzTP0xFV-MocwsScjiSbYCVCI";if(console.log("Supabase config check:",{url:r?"Present":"Missing",key:a?"Present":"Missing",nodeEnv:"production"}),!r||!a)throw console.error("Missing Supabase environment variables"),Error("Missing required Supabase environment variables: NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY");let o=(0,n.eI)(r,a,{auth:{persistSession:!1}})}},function(e){e.O(0,[683,971,117,744],function(){return e(e.s=7305)}),_N_E=e.O()}]);